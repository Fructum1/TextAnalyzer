from typing import List, Dict, Set, Iterable
import asyncio
from tokenizer import Token


class RussianNormalizer:
    def __init__(self):
        self._stop_words = self._load_stop_words()
        self._synonyms = self._load_synonyms()
    
    async def normalize(self, tokens: Iterable[Token]) -> List[Token]:
        from tokenizer import Token
        from stem_processor import MyStemProcessor
        
        my_stem_processor = MyStemProcessor()
        
        words_to_process = [token.value for token in tokens]
        text = " ".join(words_to_process)
        
        my_stem_result = await my_stem_processor.analyze_text(text)
        
        result = []
        word_index = 0
        
        for token in tokens:
            if token.is_emoji:
                result.append(token)
            else:
                current_word = token.value
                
                if current_word in my_stem_result:
                    analyze_result = my_stem_result[current_word]
                    lemma = analyze_result.lemma
                    
                    if lemma is not None and lemma not in self._stop_words:
                        normalized_word = self._synonyms.get(lemma, lemma)
                        
                        normalized_token = Token(
                            value=normalized_word,
                            original_value=token.original_value,
                            is_emoji=False
                        )
                        result.append(normalized_token)
                    else:
                        continue
                else:
                    result.append(token)
                word_index += 1
        
        return result
    
    @staticmethod
    def _load_stop_words() -> Set[str]:
        return {
            # Местоимения
            "я", "ты", "он", "она", "оно", "мы", "вы", "они", "меня", "тебя", "его", "её", 
            "нас", "вас", "их", "мне", "тебе", "ему", "ей", "нам", "вам", "им", "мной", 
            "тобой", "им", "ей", "нами", "вами", "ими", "мой", "твой", "его", "её", "наш", 
            "ваш", "их", "моя", "твоя", "его", "её", "наша", "ваша", "их", "моё", "твоё", 
            "его", "её", "наше", "ваше", "их", "мои", "твои", "его", "её", "наши", "ваши", 
            "их", "себя", "себе", "собой",
            
            # Предлоги
            "в", "во", "на", "над", "под", "к", "ко", "от", "из", "с", "со", "у", "о", "об", 
            "обо", "по", "до", "без", "из-за", "из-под", "за", "перед", "при", "про", "ради", 
            "сквозь", "среди", "через", "вне", "внутри", "вокруг", "впереди", "после", "около",
            "мимо", "напротив", "вдоль", "поперёк", "близ", "ввиду", "вследствие", "насчёт",
            
            # Союзы
            "и", "а", "но", "или", "либо", "ни", "да", "что", "чтобы", "как", "когда", "если",
            "потому", "так", "тоже", "также", "зато", "причем", "причём", "однако", "тем", 
            "нежели", "словно", "будто", "точно", "если", "хотя", "пусть", "раз", "ли", "ль",
            
            # Вводные слова
            "конечно", "безусловно", "несомненно", "очевидно", "вероятно", "возможно", 
            "наверное", "может", "может быть", "кажется", "видимо", "пожалуй", "вообще",
            "в общем", "в целом", "короче", "итак", "таким образом", "следовательно",
            "значит", "например", "так сказать", "допустим", "положим", "слава", "богу",
            "кстати", "между прочим", "впрочем", "однако", "тем не менее", "всё-таки",
            
            # Временные указатели
            "сейчас", "теперь", "сейчас", "уже", "еще", "ещё", "только", "лишь", "вдруг",
            "некогда", "когда-то", "иногда", "всегда", "никогда", "постоянно", "часто",
            "редко", "иногда", "порой", "подчас", "сразу", "сначала", "потом", "затем",
            "после", "позже", "рано", "поздно", "вчера", "сегодня", "завтра", "утром",
            "днём", "вечером", "ночью", "сразу", "сразу же",
            
            # Количественные указатели
            "много", "мало", "немного", "немало", "сколько", "столько", "несколько",
            "сколько-то", "столько-то", "больше", "меньше", "больший", "меньший",
            "большинство", "меньшинство", "множество", "несколько", "пара", "десяток",
            "сотня", "тысяча", "миллион", "миллиард",
            
            # Пространственные указатели
            "здесь", "тут", "там", "везде", "всюду", "нигде", "где-то", "куда-то",
            "откуда-то", "сюда", "туда", "отсюда", "оттуда", "вверху", "внизу", "слева",
            "справа", "впереди", "сзади", "внутри", "снаружи", "вокруг", "около", "близко",
            "далеко", "рядом", "поблизости", "вдали", "наверху", "внизу",
            
            # Модальные и вспомогательные глаголы
            "быть", "был", "была", "было", "были", "стать", "стал", "стала", "стало", "стали",
            "казаться", "казался", "казалась", "казалось", "казались", "явиться", "явился",
            "явилась", "явилось", "явились", "являться", "являюсь", "являешься", "является",
            "являемся", "являетесь", "являются", "мочь", "могу", "можешь", "может", "можем",
            "можете", "могут", "смочь", "смог", "смогла", "смогло", "смогли", "хотеть",
            "хочу", "хочешь", "хочет", "хотим", "хотите", "хотят", "захотеть", "захотел",
            "захотела", "захотело", "захотели", "должен", "должна", "должно", "должны",
            "надо", "нужно", "необходимо", "следует", "стоит", "приходится",
            
            # Вопросительные слова
            "кто", "что", "какой", "каков", "чей", "который", "сколько", "как", "где", 
            "куда", "откуда", "когда", "зачем", "почему", "отчего", "как", "ли",
            
            # Прочие частые слова без эмоциональной окраски
            "это", "то", "вот", "вон", "тут", "там", "здесь", "весь", "всё", "вся", "все",
            "сам", "сама", "само", "сами", "самый", "самая", "самое", "самые", "каждый",
            "каждая", "каждое", "каждые", "любой", "любая", "любое", "любые", "иной",
            "иная", "иное", "иные", "другой", "другая", "другое", "другие", "некий",
            "некая", "некое", "некие", "некоторый", "некоторая", "некоторое", "некоторые",
            "какой-либо", "какая-либо", "какое-либо", "какие-либо", "чей-либо", "чья-либо",
            "чьё-либо", "чьи-либо", "сколько-либо", "кто-либо", "что-либо", "как-либо",
            "где-либо", "куда-либо", "откуда-либо", "когда-либо", "зачем-либо", "почему-либо",
            
            # Числительные
            "один", "два", "три", "четыре", "пять", "шесть", "семь", "восемь", "девять", 
            "десять", "одиннадцать", "двенадцать", "тринадцать", "четырнадцать", "пятнадцать",
            "шестнадцать", "семнадцать", "восемнадцать", "девятнадцать", "двадцать", "тридцать",
            "сорок", "пятьдесят", "шестьдесят", "семьдесят", "восемьдесят", "девяносто",
            "сто", "двести", "триста", "четыреста", "пятьсот", "шестьсот", "семьсот",
            "восемьсот", "девятьсот", "тысяча", "миллион", "миллиард",
            
            # Дни недели и месяцы
            "понедельник", "вторник", "среда", "четверг", "пятница", "суббота", "воскресенье",
            "январь", "февраль", "март", "апрель", "май", "июнь", "июль", "август", "сентябрь",
            "октябрь", "ноябрь", "декабрь",
        }
    
    @staticmethod
    def _load_synonyms() -> Dict[str, str]:
        return {
            "отлично": "хороший",
            "прекрасно": "хороший", 
            "замечательно": "хороший",
            "ужасно": "плохой",
            "отвратительно": "плохой", 
            "кошмарно": "плохой",
            "ненавижу": "негативный",
            "терпеть": "негативный"
        }